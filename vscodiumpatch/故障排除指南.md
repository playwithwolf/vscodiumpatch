# VSCodium 补丁集成故障排除指南

本文档提供使用 `apply-patches-direct.sh` 脚本时常见问题的解决方案。

## 🔧 脚本执行问题

### 权限问题

**问题**：脚本无法执行或提示权限不足

**解决方案**：
```bash
# 设置执行权限
chmod +x vscodiumpatch/scripts/apply-patches-direct.sh
```

### 路径问题

**问题**："源码路径不是有效的 VSCode 目录"

**解决方案**：
1. 确保在 VSCode 源码目录中执行脚本
2. 检查目录中是否存在 `package.json` 和 `product.json` 文件
3. 确保目录结构正确：
   ```
   vscode/
   ├── package.json
   ├── product.json
   └── src/vs/code/electron-main/main.ts
   ```

## 🔧 补丁应用问题

### 补丁应用失败

**问题**：补丁无法正确应用到目标文件

**解决方案**：
1. **检查文件是否已被修改**：
   ```bash
   # 检查文件是否包含补丁内容
   grep -n "electron-updater" package.json
   grep -n "updateUrl" product.json
   grep -n "autoUpdater" src/vs/code/electron-main/main.ts
   ```

2. **从备份恢复原始文件**：
   ```bash
   # 查看可用备份
   ls -la backup/
   
   # 恢复原始文件（替换时间戳）
   cp backup/20240101_120000/* ./
   ```

### 补丁已存在

**问题**：脚本显示"补丁已存在，跳过"

**说明**：这是正常行为，脚本会自动检测已应用的补丁并跳过，避免重复应用。

**如需重新应用**：
```bash
# 从备份恢复原始文件后重新运行脚本
cp backup/20240101_120000/* ./
bash ../vscodiumpatch/scripts/apply-patches-direct.sh
```

## 🔧 验证补丁应用

### 检查补丁是否成功应用

**方法**：
```bash
# 检查 package.json 中的依赖
grep -A 5 -B 5 "electron-updater" package.json

# 检查 product.json 中的更新URL
grep -n "updateUrl" product.json

# 检查 main.ts 中的自动更新代码
grep -n "autoUpdater" src/vs/code/electron-main/main.ts
```

**预期结果**：
- `package.json` 应包含 `electron-updater` 和 `electron-log` 依赖
- `product.json` 应包含 `"updateUrl": "http://192.168.0.3:3000"`
- `main.ts` 应包含自动更新相关代码

## 🔄 恢复和重试

### 恢复到原始状态

```bash
# 使用自动备份恢复
cp backup/20240101_120000/* ./

# 或使用 git 重置（如果在 git 仓库中）
git checkout -- .
git clean -fd
```

### 重新应用补丁

```bash
# 恢复原始文件后重新运行脚本
bash ../vscodiumpatch/scripts/apply-patches-direct.sh
```

## 📚 相关文档

- [集成指南.md](./集成指南.md) - 快速集成指南和使用方法